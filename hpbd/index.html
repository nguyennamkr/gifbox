<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu√† Sinh Nh·∫≠t B√≠ M·∫≠t</title>
    <!-- T·∫£i Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- T·∫£i Tone.js cho hi·ªáu ·ª©ng √¢m thanh nh·ªè --><script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pacifico&family=Inter:wght@100..900&display=swap');
        
        /* CƒÇN CH·ªàNH TI√äU CHU·∫®N (ROBUST FLEXBOX) */
        html, body {
            /* ƒê·∫£m b·∫£o chi·ªÅu cao c∆° s·ªü */
            height: 100%; 
        }
        
        body {
            font-family: 'Inter', sans-serif;
            /* Y√äU C·∫¶U: Chi·∫øm √≠t nh·∫•t 100% viewport, cho ph√©p cu·ªôn n·∫øu n·ªôi dung l·ªõn */
            min-height: 100vh; 
            
            /* PH∆Ø∆†NG PH√ÅP CƒÇN GI·ªÆA M·∫†NH M·∫º */
            display: flex;
            justify-content: center; /* CƒÉn gi·ªØa ngang */
            align-items: center;     /* CƒÉn gi·ªØa d·ªçc */
            
            background: linear-gradient(135deg, #fef4f4 0%, #ffdfd9 50%, #fef3c7 100%);
            overflow-x: hidden;
            padding: 20px 0; /* Padding d·ªçc ƒë·ªÉ tr√°nh n·ªôi dung ch·∫°m s√°t m√©p */
        }

        .heart-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }
        .floating-item {
            position: absolute;
            font-size: 24px;
            animation: fly-up linear infinite;
            opacity: 0;
            filter: drop-shadow(0 3px 5px rgba(255, 100, 150, 0.6)); 
        }
        @keyframes fly-up {
            0% { opacity: 0; transform: translateY(100vh) scale(0.5) rotate(0deg); }
            10% { opacity: 0.9; }
            90% { opacity: 0.9; }
            100% { opacity: 0; transform: translateY(-10vh) scale(1.5) rotate(360deg); } 
        }
        .pacifico-font { font-family: 'Pacifico', cursive; } 
        /* TƒÉng kho·∫£ng c√°ch d√≤ng cho ti√™u ƒë·ªÅ ch√≠nh */
        .extra-loose-line {
            line-height: 1.8 !important; 
        }

        #love-charge-bar {
            height: 20px;
            background-color: #fce7f3; 
            border-radius: 9999px;
            overflow: hidden;
            margin-bottom: 1.5rem;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        #charge-progress {
            width: 0%;
            height: 100%; 
            background-color: #ec4899; 
            transition: width 0.1s ease-out; 
            border-radius: 9999px;
        }
        .confetti {
            position: absolute;
            width: 8px;
            height: 8px;
            opacity: 0;
            border-radius: 50%;
            animation: confetti-fall linear infinite;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* Dramatic Heart Pulse Animation */
        @keyframes heart-pulse {
            0% { transform: scale(1); filter: drop-shadow(0 0 5px rgba(255, 60, 100, 0.5)); }
            50% { transform: scale(1.15); filter: drop-shadow(0 0 30px #f44336); }
            100% { transform: scale(1); filter: drop-shadow(0 0 5px rgba(255, 60, 100, 0.5)); }
        }
        .pulsing-heart {
            animation: heart-pulse 1.5s infinite ease-in-out;
        }
        
        /* Shake animation for code error */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        .animate-shake {
            animation: shake 0.5s ease-in-out;
        }
    </style>
</head>
<body>
<!-- Deploy test 1 -->
    <!-- DECORATION LAYER: Floating Birthday Items Effect --><div class="heart-container"></div>

    <!-- Main Content Container (Structural Layer 2) -->
    <div id="main-container" class="bg-white/95 p-8 md:p-12 rounded-3xl shadow-[0_20px_50px_rgba(0,0,0,0.25)] backdrop-blur-sm 
                                    max-w-md md:max-w-lg w-11/12 text-center 
                                    /* CƒÇN GI·ªÆA B·∫∞NG MX-AUTO V√Ä FLEXBOX TRONG BODY */
                                    mx-auto
                                    transition-all duration-700 ease-in-out z-10 relative">
        
        <!-- Confetti Layer (Decorative Layer 4, initially hidden) --><div id="confetti-cannon" class="absolute inset-0 z-20 pointer-events-none opacity-0 transition-opacity duration-500"></div>

        <!-- LAYER 1: COUNTDOWN (Initial View) --><div id="layer-countdown" class="transition-opacity duration-500">
            
            <!-- TI√äU ƒê·ªÄ T√í M√í H∆†N -->
            <h1 class="pacifico-font text-4xl md:text-5xl font-extrabold text-pink-600 drop-shadow-md mb-10">
                B√≠ M·∫≠t ƒêang Ch·ªù: Gi·∫£i M√£ Th·ªùi Gian...
            </h1>

            <!-- Countdown Timer -->
            <div id="countdown-display" class="grid grid-cols-4 gap-3 md:gap-4 mb-10">
                <div class="p-2 sm:p-3 bg-red-50 rounded-xl shadow-lg border-2 border-pink-200">
                    <!-- FIX: Gi·∫£m k√≠ch th∆∞·ªõc s·ªë ƒë·∫øm tr√™n mobile -->
                    <div id="days" class="text-3xl sm:text-4xl md:text-5xl font-bold text-red-500">00</div>
                    <div class="text-xs sm:text-sm font-medium text-gray-500 mt-1">Ng√†y</div>
                </div>
                <div class="p-2 sm:p-3 bg-red-50 rounded-xl shadow-lg border-2 border-pink-200">
                    <!-- FIX: Gi·∫£m k√≠ch th∆∞·ªõc s·ªë ƒë·∫øm tr√™n mobile -->
                    <div id="hours" class="text-3xl sm:text-4xl md:text-5xl font-bold text-red-500">00</div>
                    <div class="text-xs sm:text-sm font-medium text-gray-500 mt-1">Gi·ªù</div>
                </div>
                <div class="p-2 sm:p-3 bg-red-50 rounded-xl shadow-lg border-2 border-pink-200">
                    <!-- FIX: Gi·∫£m k√≠ch th∆∞·ªõc s·ªë ƒë·∫øm tr√™n mobile -->
                    <div id="minutes" class="text-3xl sm:text-4xl md:text-5xl font-bold text-red-500">00</div>
                    <div class="text-xs sm:text-sm font-medium text-gray-500 mt-1">Ph√∫t</div>
                </div>
                <div class="p-2 sm:p-3 bg-red-50 rounded-xl shadow-lg border-2 border-pink-200">
                    <!-- FIX: Gi·∫£m k√≠ch th∆∞·ªõc s·ªë ƒë·∫øm tr√™n mobile -->
                    <div id="seconds" class="text-3xl sm:text-4xl md:text-5xl font-bold text-red-500">00</div>
                    <div class="text-xs sm:text-sm font-medium text-gray-500 mt-1">Gi√¢y</div>
                </div>
            </div>

            <!-- NEW: Code Input Area -->
            <div id="code-input-area" class="mt-8 mb-6 opacity-0 pointer-events-none transition-opacity duration-500">
                <!-- VƒÇN B·∫¢N ƒê√É S·ª¨A ƒê·ªîI -->
                <p class="text-lg font-semibold text-gray-700 mb-3">Qu√Ω c√¥ n∆∞∆°ng xu·∫•t tr√¨nh VNIED:</p>
                <!-- ƒê√£ ch·ªânh maxlength th√†nh 4 -->
                <input type="text" id="secret-code-input" placeholder="Nh·∫≠p m√£ b√≠ m·∫≠t..." 
                       class="w-full p-3 text-center border-2 border-pink-300 rounded-lg text-xl font-mono uppercase focus:ring-pink-500 focus:border-pink-500 transition duration-300 shadow-inner" 
                       maxlength="4" disabled>
                <p id="code-error" class="text-sm text-red-500 mt-2 h-5 font-medium"></p>
            </div>
            
            <!-- Layer 1 Interaction Button -->
            <button id="reveal-layer2-button" class="w-full py-4 px-6 bg-gray-400 text-white font-bold text-lg rounded-xl shadow-xl shadow-gray-300/50 transform hover:scale-105 transition-all duration-300 active:scale-100 disabled:opacity-50">
                H·ªôp M·∫≠t M√£ ƒê√£ Kh√≥a
            </button>
            
        </div>

        <!-- LAYER 2: LOVE CHARGE BAR (New) --><div id="layer-charge" class="opacity-0 h-0 overflow-hidden transition-all duration-700 ease-in-out">
            <!-- TƒÉng t√≠nh b√≠ ·∫©n -->
            <h2 class="text-3xl font-extrabold text-red-600 mb-4">
                üîë ƒê·ªìng B·ªô H√≥a H·ªá Th·ªëng Kh√≥a! üîë
            </h2>
            <p class="text-lg text-gray-700 mb-6">
                Gi·ªØ n√∫t **"ƒê·ªìng B·ªô"** ƒë·ªÉ m·ªü kh√≥a kho b√°u. M·ªói nh·ªãp ƒë·∫≠p l√† m·ªôt b∆∞·ªõc g·∫ßn h∆°n ƒë·∫øn l·ªùi gi·∫£i.
            </p>
            
            <!-- Progress Bar --><div id="love-charge-bar">
                <div id="charge-progress"></div>
            </div>

            <!-- Charge Button -->
            <button id="charge-button" 
                class="w-full py-4 px-6 bg-red-500 text-white font-bold text-xl rounded-full shadow-lg shadow-red-400/50 hover:bg-red-600 transition-all duration-300 transform hover:scale-105 active:scale-95 disabled:opacity-50"
                >
                ‚ö° ƒê·ªìng B·ªô (0%) ‚ö°
            </button>
        </div>


        <!-- LAYER 3: FINAL MESSAGE -->
        <!-- ƒê√£ ch·ªânh s·ª≠a font-size cho mobile v√† x√≥a hai d√≤ng cu·ªëi -->
        <div id="layer-message" class="opacity-0 h-0 overflow-hidden transition-all duration-700 ease-in-out">
            
            <!-- NEW: Dramatic Pulsing Heart Element -->
            <div id="final-heart" class="mb-4 opacity-0 transform scale-50 transition-all duration-1000 ease-out">
                <!-- SVG Heart Icon - Adjusted size for mobile -->
                <svg class="w-20 h-20 sm:w-32 sm:h-32 mx-auto text-red-500 drop-shadow-2xl" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                </svg>
            </div>
            
            <!-- Main Title adjusted font size for mobile -->
            <h1 class="text-2xl sm:text-4xl lg:text-5xl font-extrabold text-red-500 mb-4 pacifico-font animate-pulse extra-loose-line">
                Happy Birthday My Dear! ü•≥
            </h1>
            <!-- Main Paragraph adjusted font size for mobile -->
            <p class="text-base sm:text-xl text-gray-700 mb-4 leading-relaxed p-3 bg-yellow-50 rounded-xl border-l-4 border-red-400">
                Ch√∫c m·ª´ng sinh nh·∫≠t, c√¥ g√°i tuy·ªát v·ªùi! Anh ƒë√£ chu·∫©n b·ªã ƒëi·ªÅu n√†y th·∫≠t l√¢u r·ªìi. M·ªói gi√¢y ph√∫t ƒë·∫øm ng∆∞·ª£c ƒë·ªÅu l√† s·ª± h√°oo h·ª©c ch·ªù ƒë·ª£i ƒë·ªÉ g·ª≠i l·ªùi ch√∫c n√†y ƒë·∫øn em.
            </p>
            <!-- Secondary Paragraph adjusted font size for mobile -->
            <p class="text-lg sm:text-2xl font-semibold text-pink-600 mb-6 p-3 italic">
                C·∫ßu mong em c√≥ m·ªôt tu·ªïi m·ªõi tr√†n ƒë·∫ßy ni·ªÅm vui, ti·∫øng c∆∞·ªùi, v√† nh·ªØng ƒëi·ªÅu tuy·ªát v·ªùi nh·∫•t.
            </p>
            
        </div>

    </div>

    <!-- JavaScript for Countdown, Effects, and Layer Switching --><script type="module">
        // >>> EASY-TO-EDIT TARGET DATE CONFIGURATION <<<
        // VUI L√íNG ƒê·∫∂T L·∫†I NG√ÄY SINH NH·∫¨T TH·ª∞C T·∫æ C·ª¶A B·∫†N G√ÅI ·ªû ƒê√ÇY.
        // T√îI ƒêANG T·∫†M TH·ªúI ƒê·∫∂T NG√ÄY TRONG QU√Å KH·ª® ƒê·ªÇ D·ªÑ D√ÄNG TEST CH·ª®C NƒÇNG.
        const TARGET_DAY = 1; // Day (e.g., 29)
        const TARGET_MONTH_1_INDEXED = 11; // Month (1 = Jan, 12 = Dec)
        const TARGET_YEAR_OVERRIDE = 2025; // Fixed year. Set to null to use current year.
        // >>> END CONFIGURATION <<<

        // NEW: Secret Code Configuration (ƒê√É THAY ƒê·ªîI)
        const SECRET_CODE = "2911"; // Code to unlock layer 2

        // --- GLOBAL VARIABLES ---
        const targetMonthIndex = TARGET_MONTH_1_INDEXED - 1; 

        // DOM elements
        const countdownLayer = document.getElementById('layer-countdown');
        const chargeLayer = document.getElementById('layer-charge');
        const messageLayer = document.getElementById('layer-message');
        const chargeProgress = document.getElementById('charge-progress');
        const chargeButton = document.getElementById('charge-button');
        const confettiCannon = document.getElementById('confetti-cannon');
        const revealLayer2Button = document.getElementById('reveal-layer2-button'); 
        const finalHeart = document.getElementById('final-heart'); 

        // NEW: Code Input Elements
        const secretCodeInput = document.getElementById('secret-code-input');
        const codeInputArea = document.getElementById('code-input-area');
        const codeError = document.getElementById('code-error');

        // State variables
        let isCountdownFinished = false;
        let countdownInterval;
        let chargeLevel = 0;
        let chargeInterval = null;
        let releaseInterval = null;
        const CHARGE_MAX = 100;
        const CHARGE_RATE = 5; 
        const RELEASE_RATE = 2; 

        // --- APPLICATION LOGIC (Tone.js and Countdown) ---
        
        // TONE.JS Setup 
        const synth = new Tone.Synth().toDestination();
        const playSweetSound = () => { synth.triggerAttackRelease("C4", "8n"); };

        const melodySynth = new Tone.Synth({
            oscillator: { type: "square" }, 
            envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 }
        }).toDestination();

        // Synth for Charging Sound Effect (Build-up)
        const chargeSynth = new Tone.MembraneSynth({
            envelope: { decay: 0.1, sustain: 0.05, release: 0.1 }
        }).toDestination();
        let chargeSoundLoop = null;
        let chargePitch = 100; // Start Hertz
        
        let birthdaySequence = null;

        function setupBirthdaySong() {
            const partNotes = [
                { time: "0:0", note: "G4", duration: "8n" }, { time: "0:0.5", note: "G4", duration: "8n" },
                { time: "0:1", note: "A4", duration: "4n" }, { time: "0:2", note: "G4", duration: "4n" },
                { time: "0:3", note: "C5", duration: "4n" }, { time: "1:0", note: "B4", duration: "4n" },
                
                { time: "1:2", note: "G4", duration: "8n" }, { time: "1:2.5", note: "G4", duration: "8n" },
                { time: "1:3", note: "A4", duration: "4n" }, { time: "2:0", note: "G4", duration: "4n" },
                { time: "2:1", note: "D5", duration: "4n" }, { time: "2:2", note: "C5", duration: "4n" },

                { time: "2:3", note: "G4", duration: "8n" }, { time: "2:3.5", note: "G4", duration: "8n" },
                { time: "3:0", note: "G5", duration: "4n" }, { time: "3:1", note: "E5", duration: "4n" },
                { time: "3:2", note: "C5", duration: "4n" }, { time: "3:3", note: "B4", duration: "4n" },
                { time: "4:0", note: "A4", duration: "4n" },

                { time: "4:1", note: "F5", duration: "8n" }, { time: "4:1.5", note: "F5", duration: "8n" },
                { time: "4:2", note: "E5", duration: "4n" }, { time: "4:3", note: "C5", duration: "4n" },
                { time: "5:0", note: "D5", duration: "4n" }, { time: "5:1", note: "C5", duration: "2n" } 
            ];

            birthdaySequence = new Tone.Part((time, value) => {
                melodySynth.triggerAttackRelease(value.note, value.duration, time);
            }, partNotes);

            birthdaySequence.loop = false;
            birthdaySequence.loopEnd = "6:0:0"; 

            Tone.Transport.bpm.value = 120; 
        }

        function startBirthdaySong() {
            Tone.start(); 
            Tone.Transport.stop();
            Tone.Transport.start();
            birthdaySequence.start(0); 
        }
        
        // --- COUNTDOWN LOGIC ---
        
        // Calculate the final Target Date
        const now = new Date();
        let targetYear = TARGET_YEAR_OVERRIDE !== null ? TARGET_YEAR_OVERRIDE : now.getFullYear();
        let calculatedTargetDate = new Date(targetYear, targetMonthIndex, TARGET_DAY, 0, 0, 0);
        const targetDate = calculatedTargetDate.getTime();
        const targetDateDisplayString = `${TARGET_DAY}/${TARGET_MONTH_1_INDEXED}/${targetYear}`;
        
        function formatTime(time) { return time < 10 ? `0${time}` : time; }
        
        function updateCountdown() {
            const nowTime = new Date().getTime();
            const distance = targetDate - nowTime;

            if (distance <= 0) {
                isCountdownFinished = true;
                
                document.getElementById('days').textContent = '00';
                document.getElementById('hours').textContent = '00';
                document.getElementById('minutes').textContent = '00';
                document.getElementById('seconds').textContent = '00';

                // Logic hi·ªÉn th·ªã √¥ nh·∫≠p m√£ khi countdown k·∫øt th√∫c
                codeInputArea.style.opacity = '1';
                codeInputArea.classList.remove('pointer-events-none');
                secretCodeInput.disabled = false;
                
                revealLayer2Button.disabled = false;
                // C·∫¨P NH·∫¨T: Button Unlock
                revealLayer2Button.textContent = 'GI·∫¢I M√É & M·ªû KH√ìA >>';
                revealLayer2Button.classList.remove('bg-gray-400', 'shadow-gray-300/50');
                revealLayer2Button.classList.add('bg-pink-500', 'shadow-pink-400/50', 'hover:scale-105');

            } else {
                isCountdownFinished = false;

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                document.getElementById('days').textContent = formatTime(days);
                document.getElementById('hours').textContent = formatTime(hours);
                document.getElementById('minutes').textContent = formatTime(minutes);
                document.getElementById('seconds').textContent = formatTime(seconds);

                // Logic ·∫©n √¥ nh·∫≠p m√£ khi countdown ƒëang ch·∫°y
                codeInputArea.style.opacity = '0';
                codeInputArea.classList.add('pointer-events-none');
                secretCodeInput.disabled = true;

                revealLayer2Button.disabled = true;
                // C·∫¨P NH·∫¨T: Button Locked
                revealLayer2Button.textContent = `H·ªôp M·∫≠t M√£ ƒê√£ Kh√≥a`; 
                revealLayer2Button.classList.remove('bg-pink-500', 'shadow-pink-400/50', 'hover:scale-105');
                revealLayer2Button.classList.add('bg-gray-400', 'shadow-gray-300/50');
            }
        }

        // --- SHOW LAYER 2: Charge Screen (Now checks code) ---
        function showLayerTwo() {
            if (!isCountdownFinished) {
                console.warn("Attempted to unlock before countdown finished. Operation denied.");
                return; 
            }
            if (revealLayer2Button.disabled) return; 

            // NEW: Check Secret Code
            const enteredCode = secretCodeInput.value.trim();
            // KH√îNG TOUPPERCASE V√å ƒê√ÇY L√Ä S·ªê
            if (enteredCode !== SECRET_CODE) {
                codeError.textContent = 'M√£ kh√¥ng ƒë√∫ng! H√£y th·ª≠ l·∫°i.';
                // Add shake effect on failure
                codeInputArea.classList.add('animate-shake');
                setTimeout(() => {
                    codeInputArea.classList.remove('animate-shake');
                }, 500);
                return; 
            }
            codeError.textContent = ''; // Clear error message on success
            
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            countdownLayer.style.opacity = '0';
            countdownLayer.style.height = '0';
            countdownLayer.style.overflow = 'hidden';

            releaseInterval = setInterval(releaseCharge, 100); 

            setTimeout(() => {
                chargeLayer.style.opacity = '1';
                chargeLayer.style.height = 'auto';
            }, 500); 
        }

        // --- CHARGING MECHANISM ---
        function updateChargeDisplay() {
            chargeProgress.style.width = `${chargeLevel}%`;
            
            // C·∫¨P NH·∫¨T: Dynamic Button Text cho c·∫£m gi√°c t√≤ m√≤ v√† ti·∫øn tri·ªÉn
            let buttonText = `‚ö° ƒê·ªìng B·ªô (${Math.floor(chargeLevel)}%) ‚ö°`;
            
            if (chargeLevel >= 0 && chargeLevel < 30) {
                buttonText = `üîé Kh·ªüi ƒë·ªông h·ªá th·ªëng... (${Math.floor(chargeLevel)}%) üóùÔ∏è`;
            } else if (chargeLevel >= 30 && chargeLevel < 70) {
                buttonText = `‚è≥ TƒÉng t·ªëc ƒë·ªô gi·∫£i m√£! (${Math.floor(chargeLevel)}%) ‚è≥`;
            } else if (chargeLevel >= 70 && chargeLevel < 100) {
                buttonText = `üö® S·∫Øp ƒë·∫°t ƒë·∫øn c·ª±c ƒëi·ªÉm b√≠ ·∫©n! (${Math.floor(chargeLevel)}%) üö®`;
            } else if (chargeLevel >= 100) {
                buttonText = `üîì ƒê√É GI·∫¢I M√É TH√ÄNH C√îNG! üíñ`;
            }

            chargeButton.textContent = buttonText;
        }
        
        function releaseCharge() {
            if (chargeLevel > 0) {
                chargeLevel -= RELEASE_RATE;
                if (chargeLevel < 0) chargeLevel = 0;
                updateChargeDisplay();
            }
        }

        function startCharging() {
            if (chargeInterval) return; 
            Tone.start().then(() => { console.log("Audio context started."); });
            
            chargeButton.classList.add('animate-pulse', 'bg-red-700'); 
            
            // Start the dramatic sound loop
            chargePitch = 100;
            if (!chargeSoundLoop) {
                chargeSoundLoop = new Tone.Loop(time => {
                    // T·∫ßn s·ªë tƒÉng l√™n theo m·ª©c s·∫°c (100 Hz ƒë·∫øn 1000 Hz)
                    chargePitch = 100 + (chargeLevel * 9); 
                    if (chargePitch > 1000) chargePitch = 1000;
                    
                    chargeSynth.triggerAttackRelease(chargePitch, "16n", time);
                }, "8n").start(0);
                Tone.Transport.start(); 
            }
            
            chargeInterval = setInterval(() => {
                chargeLevel += CHARGE_RATE;
                
                if (chargeLevel >= CHARGE_MAX) {
                    chargeLevel = CHARGE_MAX;
                    stopCharging();
                    showLayerThree(); 
                    return;
                }
                updateChargeDisplay();
            }, 100); 
        }

        function stopCharging() {
            clearInterval(chargeInterval);
            chargeInterval = null;
            chargeButton.classList.remove('animate-pulse', 'bg-red-700');
            
            // Stop and dispose the sound loop when charging stops
            if (chargeSoundLoop) {
                chargeSoundLoop.stop();
                chargeSoundLoop.dispose();
                chargeSoundLoop = null;
                Tone.Transport.stop(); 
            }
            
            updateChargeDisplay();
        }

        // --- SHOW LAYER 3: Final Message ---
        function showLayerThree() {
            clearInterval(releaseInterval); 
            
            // Flash effect for extra impact
            document.body.style.transition = 'background-color 0.1s';
            document.body.style.backgroundColor = '#ffffff';
            setTimeout(() => {
                document.body.style.backgroundColor = ''; 
                document.body.transition = '';
            }, 100);

            chargeLayer.style.opacity = '0';
            chargeLayer.style.height = '0';
            chargeLayer.style.overflow = 'hidden';

            launchConfetti();
            playSweetSound();
            startBirthdaySong(); 
            
            // Heart Reveal and Pulsing Animation
            finalHeart.classList.add('pulsing-heart');
            finalHeart.style.opacity = '1';
            finalHeart.style.transform = 'scale(1)'; 

            setTimeout(() => {
                messageLayer.style.opacity = '1';
                messageLayer.style.height = 'auto';
                confettiCannon.style.opacity = '1'; 
            }, 500);
        }

        // --- FLOATING BIRTHDAY ITEMS EFFECT ---
        function createFloatingItems() {
            const container = document.querySelector('.heart-container');
            const birthdayEmojis = ['üéÇ', 'üéÅ', 'üéà', 'üå∏', 'üíñ'];
            for (let i = 0; i < 20; i++) { 
                const item = document.createElement('div');
                item.classList.add('floating-item');
                const emoji = birthdayEmojis[Math.floor(Math.random() * birthdayEmojis.length)];
                item.innerHTML = emoji;
                const size = Math.random() * 12 + 18; 
                item.style.fontSize = `${size}px`;
                item.style.left = `${Math.random() * 100}vw`;
                item.style.animationDuration = `${Math.random() * 15 + 10}s`;
                item.style.animationDelay = `${Math.random() * 5}s`;
                container.appendChild(item);
            }
        }
        
        // --- CONFETTI CANNON EFFECT ---
        function launchConfetti() {
            const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#00bcd4', '#009688', '#ffeb3b', '#ff9800', '#ff5722'];
            for (let i = 0; i < 150; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                
                const posX = Math.random() * 40 - 20; 
                confetti.style.left = `calc(50% + ${posX}%)`; 
                confetti.style.top = `50%`;

                confetti.style.animationDuration = `${Math.random() * 3 + 2}s`;
                confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                confetti.style.animationName = 'confetti-fall';
                confetti.style.animationIterationCount = '1';
                
                const styleSheet = document.styleSheets[0];
                const angle = Math.random() * 360;
                const distance = Math.random() * 400 + 100;
                confetti.style.transform = `translateY(0) rotate(0deg)`; 
                
                const keyframes = `@keyframes confetti-fall-${i} {
                    0% { transform: translate(0, 0) rotate(0deg); opacity: 1; }
                    100% { 
                        transform: translate(${Math.cos(angle * Math.PI / 180) * distance}px, ${Math.sin(angle * Math.PI / 180) * distance * 1.5}px) rotate(720deg); 
                        opacity: 0; 
                    }
                }`;
                styleSheet.insertRule(keyframes, styleSheet.cssRules.length);
                confetti.style.animationName = `confetti-fall-${i}`;
                
                confettiCannon.appendChild(confetti);
            }
        }
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            setupBirthdaySong(); 
            updateCountdown(); 
            createFloatingItems(); 
            
            countdownInterval = setInterval(updateCountdown, 1000);

            // Attach button events
            revealLayer2Button.addEventListener('click', showLayerTwo);
            chargeButton.addEventListener('mousedown', startCharging);
            chargeButton.addEventListener('mouseup', stopCharging);
            chargeButton.addEventListener('touchstart', startCharging);
            chargeButton.addEventListener('touchend', stopCharging);

            // Ensure input is focused when revealed
            secretCodeInput.addEventListener('focus', () => codeError.textContent = '');
        });

        chargeButton.addEventListener('contextmenu', e => e.preventDefault());

    </script>

</body>
</html>
